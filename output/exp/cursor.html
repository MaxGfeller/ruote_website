<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head>
    <meta content='text/html; charset=UTF-8' http-equiv='Content-Type' />
    <title>ruote - cursor expression</title>
    <script src='/js/shCore.js'></script>
    <script src='/js/shBrushRuby.js'></script>
    <script src='/js/shBrushJScript.js'></script>
    <script src='/js/shBrushXml.js'></script>
    <link href='/css/reset.css' rel='stylesheet' type='text/css' />
    <link href='/css/shCore.css' rel='stylesheet' type='text/css' />
    <link href='/css/shThemeDefault.css' rel='stylesheet' type='text/css' />
    <link href='/css/ruote.css' rel='stylesheet' type='text/css' />
  </head><body>
    <div id='container'>
      <div id='header'>
        <div id='header-top'>
          <div id='header-left'>
            <a href='/'>
              <img align='left' src='/images/ruote.png' />
              <span id='ruote' onclick="location.href = '/'; return true;">
                ruote 2.1
              </span>
            </a>
          </div>
          <div id='header-right'>
          </div>
        </div>
        <div id='header-bottom'>
          <div id='header-subtitle'>
            open source ruby workflow engine
          </div>
          <div id='header-menu'>
            <a href='documentation.html' title='documentation'>doc</a>
            <a href='source.html' title='source code'>source</a>
            <a href='download.html' title='download'>download</a>
            <a href='lists.html' title='mailing lists and irc'>lists</a>
            <a href='http://jmettraux.wordpress.com' title='blog'>blog</a>
            <a href='map.html' title='map'>map</a>
            <a class='nihongo' href='ja.html' title='日本語'>日本語</a>
          </div>
        </div>
      </div>
      <div id='content'>
        <h2>cursor</h2>
        <p>This class implements the &#8216;cursor&#8217; and the &#8216;repeat&#8217; (loop) expressions.</p>
        <p>The cursor expression is a kind of enhanced &#8216;sequence&#8217;. Like a sequence<br />
        it will execute its child expression one by one, sequentially. Unlike a<br />
        sequence though, it will obey &#8216;commands&#8217;.</p>
        <pre class="brush: ruby">
          cursor do
            author
            reviewer
            rewind :if =&gt; '${f:not_ok}'
            publisher
          end
        </pre>
        <p>In this simplistic example, the process will flow from author to reviewer<br />
        and back until the reviewer sets the workitem field &#8216;not_ok&#8217; to something<br />
        else than the value &#8216;true&#8217;.</p>
        <p>There are two ways to pass commands to a cursor either directly from<br />
        the process definition with a cursor command expression, either via<br />
        the workitem &#8216;<i>command</i>&#8217; [special] field.</p>
        <h3>cursor commands</h3>
        <p>The commands that a cursor understands are listed here. The most powerful<br />
        ones are &#8216;rewind&#8217; and &#8216;jump&#8217;.</p>
        <h4>rewind</h4>
        <p>Rewinds the cursor up to its first child expression.</p>
        <pre class="brush: ruby">
          cursor do
            author
            reviewer
            rewind :if =&gt; '${f:not_ok}'
            publisher
          end
        </pre>
        <h4>stop, over &amp; break</h4>
        <p>Exits the cursor.</p>
        <pre class="brush: ruby">
          cursor do
            author
            reviewer
            rewind :if =&gt; '${f:review} == fix'
            stop :if =&gt; '${f:review} == abort'
            publisher
          end
        </pre>
        <p>&#8216;_break&#8217; or &#8216;over&#8217; can be used instead of &#8216;stop&#8217;.</p>
        <h4>skip &amp; back</h4>
        <p>Those two commands jump forth and back respectively. By default, they<br />
        skip 1 child, but they accept a numeric parameter holding the number<br />
        of children to skip.</p>
        <pre class="brush: ruby">
          cursor do
            author
            reviewer
            rewind :if =&gt; '${f:review} == fix'
            skip 2 :if =&gt; '${f:review} == publish'
            reviewer2
            rewind :if =&gt; '${f:review} == fix'
            publisher
          end
        </pre>
        <h4>jump</h4>
        <p>Jump is probably the most powerful of the cursor commands. It allows to<br />
        jump to a specified expression that is a direct child of the cursor.</p>
        <pre class="brush: ruby">
          cursor do
            author
            reviewer
            jump :to =&gt; 'author', :if =&gt; '${f:review} == fix'
            jump :to =&gt; 'publisher', :if =&gt; '${f:review} == publish'
            reviewer2
            jump :to =&gt; 'author', :if =&gt; '${f:review} == fix'
            publisher
          end
        </pre>
        <p>Note that the :to accepts the name of an expression or the value of<br />
        its :ref attribute or the value of its :tag attribute.</p>
        <pre class="brush: ruby">
          cursor do
            participant :ref =&gt; 'author'
            participant :ref =&gt; 'reviewer'
            jump :to =&gt; 'author', :if =&gt; '${f:review} == fix'
            participant :ref =&gt; 'publisher'
          end
        </pre>
        <h3>cursor command with :ref</h3>
        <p>It&#8217;s OK to tag a cursor/repeat/loop with the :tag attribute and then<br />
        point a command to it via :ref :</p>
        <pre class="brush: ruby">
          concurrence do
        
            cursor :tag =&gt; 'main' do
              author
              editor
              publisher
            end
        
            # meanwhile ...
        
            sequence do
              sponsor
              rewind :ref =&gt; 'main', :if =&gt; '${f:stop}'
            end
          end
        </pre>
        <p>This :ref technique may also be used with nested cursor/loop/iterator<br />
        constructs :</p>
        <pre class="brush: ruby">
          cursor :tag =&gt; 'main' do
            cursor do
              author
              editor
              rewind :if =&gt; '${f:not_ok}'
              _break :ref =&gt; 'main', :if =&gt; '${f:abort_everything}'
            end
            head_of_edition
            rewind :if =&gt; '${f:not_ok}'
            publisher
          end
        </pre>
        <p>this example features two nested cursors. There is a &#8220;_break&#8221; in the inner<br />
        cursor, but it will break the main &#8216;cursor&#8217; (and thus break the whole<br />
        review process).</p>
        <h3>cursor command in the workitem</h3>
        <p>The command expressions are merely setting the workitem field &#8216;<i>command</i>&#8217;<br />
        with an array value [ {command}, {arg} ].</p>
        <p>For example,</p>
        <pre class="brush: ruby">
          jump :to =&gt; 'author'
            # is equivalent to
          set 'field:__command__' =&gt; 'author'
        </pre>
        <p>It is entirely OK to have a participant implementation that sets <i>command</i><br />
        by itself.</p>
        <pre class="brush: ruby">
          class Reviewer
            include Ruote::LocalParticipant
        
            def consume (workitem)
              # somehow review the book
              if review == 'bad'
                #workitem.fields['__command__'] = [ 'rewind' ] # old style
                workitem.command = 'rewind' # new style
              else
                # let it go
              end
              reply_to_engine(workitem)
            end
        
            def cancel (fei, flavour)
              # cancel if review is still going on...
            end
          end
        </pre>
        <p>This example uses the Ruote::Workitem#command= method which can be fed<br />
        strings like &#8216;rewind&#8217;, &#8216;skip 2&#8217;, &#8216;jump to author&#8217; or the equivalent arrays<br />
        [ &#8216;rewind&#8217; ], [ &#8216;skip&#8217;, 2 ], [ &#8216;jump&#8217;, &#8216;author&#8217; ].</p>
        <h3>:break_if / :rewind_if</h3>
        <p>As an attribute of the cursor/repeat expression, you can set a :break_if.<br />
        It tells the cursor (loop) if it has to break.</p>
        <pre class="brush: ruby">
          cursor :break_if =&gt; '${f:completed}' do
            participant 'alpha'
            participant 'bravo'
            participant 'charly'
          end
        </pre>
        <p>If alpha or bravo replies and the field &#8216;completed&#8217; is set to true, this<br />
        cursor will break.</p>
        <p>:break_unless is accepted. :over_if and :over_unless are synonyms for<br />
        :break_if and :break_unless respectively.</p>
        <p>:rewind_if / :rewind_unless behave the same, but the cursor/loop, instead<br />
        of breaking, is put back in its first step.</p>
        <h2>repeat (loop)</h2>
        <p>A &#8216;cursor&#8217; expression exits implicitely as soon as its last child replies<br />
        to it.<br />
        a &#8216;repeat&#8217; expression will apply (again) the first child after the last<br />
        child replied. A &#8216;break&#8217; cursor command might be necessary to exit the loop<br />
        (or a cancel_process, but that exits the whole process instance).</p>
        <pre class="brush: ruby">
          sequence do
            repeat do
              author
              reviewer
              _break :if =&gt; '${f:review} == ok'
            end
            publisher
          end
        </pre>
      </div>
      <div id='footer'>
        <div id='footer-left'>
          this website was created with
          <a href='http://nanoc.stoneship.org'>nanoc</a>
          and
          <a href='http://alexgorbatchev.com/SyntaxHighlighter/'>syntax highlighter</a>
        </div>
        <div id='footer-right'>
          &copy; 2005-2010 the ruote team
        </div>
      </div>
    </div>
    <script type='text/javascript'>
      //<![CDATA[
        SyntaxHighlighter.all();
      //]]>
    </script>
    <script src='http://www.google-analytics.com/ga.js' type='text/javascript'></script>
    <script type='text/javascript'>
      //<![CDATA[
        if (location.hostname != 'localhost' && location.hostname != '127.0.0.1') {
          var pageTracker=_gat._getTracker('UA-138748-2');
          pageTracker._initData();
          pageTracker._trackPageview();
        }
      //]]>
    </script>
  </body>
</html>
